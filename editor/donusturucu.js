var fabricObj   = {
                version:"3.6.1",
                objects:[],
                background:"#ffffff",
                agSmallImageUrl:"",
                height:"600",
                width:"800",
                id:1
    };

var bgImgObj    = 
    {
      "type": "image",
      "version": "3.6.1",
      "originX": "left",
      "originY": "top",
      "left": 0,
      "top": 0,
      "width": 600,
      "height": 840,
      "fill": "rgb(0,0,0)",
      "stroke": null,
      "strokeWidth": 0,
      "strokeDashArray": null,
      "strokeLineCap": "butt",
      "strokeDashOffset": 0,
      "strokeLineJoin": "miter",
      "strokeMiterLimit": 4,
      "scaleX": 1,
      "scaleY": 1,
      "angle": 0,
      "flipX": false,
      "flipY": false,
      "opacity": 1,
      "shadow": null,
      "visible": true,
      "clipTo": null,
      "backgroundColor": "",
      "fillRule": "nonzero",
      "paintFirst": "fill",
      "globalCompositeOperation": "source-over",
      "transformMatrix": null,
      "skewX": 0,
      "skewY": 0,
      "crossOrigin": "",
      "cropX": 0,
      "cropY": 0,
      "agSablonResmi": true,
      "evented": false,
      "hasControls": false,
      "id": "bg",
      "src": "http://tasarimabasla.test/ageditor/api/bgimages/dugun/ACKT0102.png",
      "filters": []
    }

var txtObj      = {
    "type": "textbox",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 213,
    "top": 112,
    "width": 200,
    "height": 27.119999999999994,
    "fill": "#000000",
    "stroke": "#ffffff",
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "round",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "text": "sssssss",
    "fontSize": 24,
    "fontWeight": "normal",
    "fontFamily": "arial",
    "fontStyle": "normal",
    "lineHeight": 1.16,
    "underline": false,
    "overline": false,
    "linethrough": false,
    "textAlign": "center",
    "textBackgroundColor": "",
    "charSpacing": 0,
    "minWidth": 20,
    "splitByGrapheme": false,
    "agKarakterLimiti": 30,
    "agKutuyaSigdir": 1,
    "agMaxLines": 1,
    "agMaxWidth": 200,
    "agFontSize": 24,
    "agBosBirak": false,
    "evented": true,
    "hasControls": false,
    "id": 91249,
    "styles": {}
    }

var cropObj     = {
    "type": "image",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 154,
    "top": 231,
    "width": 192,
    "height": 192,
    "fill": "rgb(0,0,0)",
    "stroke": null,
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "miter",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "crossOrigin": "",
    "cropX": 0,
    "cropY": 0,
    "agBosBirak": false,
    "evented": true,
    "hasControls": true,
    "id": 50752,
    "src": "http://tasarimabasla.test/ageditor/editor/agblank.png",
    "filters": []
    }

var fligranObj  = {
    "type": "image",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 154,
    "top": 231,
    "width": 192,
    "height": 192,
    "fill": "rgb(0,0,0)",
    "stroke": null,
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "miter",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "crossOrigin": "",
    "cropX": 0,
    "cropY": 0,
    "agBosBirak": false,
    "evented": true,
    "hasControls": true,
    "id": 50752,
    "src": "http://tasarimabasla.test/ageditor/editor/agblank.png",
    "filters": []
    }

var logoObj  = {
    "type": "image",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 154,
    "top": 231,
    "width": 192,
    "height": 192,
    "fill": "rgb(0,0,0)",
    "stroke": null,
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "miter",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "crossOrigin": "",
    "cropX": 0,
    "cropY": 0,
    "agBosBirak": false,
    "evented": true,
    "hasControls": true,
    "id": 50752,
    "src": "http://tasarimabasla.test/ageditor/editor/agblank.png",
    "filters": []
}

var progresBar = '<i class="fa fa-cog fa-spin" style="' + 
'margin-left: auto;'+
'margin-right: auto;'+
'display: block;'+
'width: 257px;'+
'height: 300px;'+
'font-size:300px;color:green"'+'></i>'



/*
document.addEventListener( 'DOMContentLoaded',  async function () {

});//----------------- END Documend Ready ------------------------
*/

async function eskiVersiondanDonustur(){
    if($('[name="product_id"]').length==0){return;}
    let product_id      = $('[name="product_id"]').val();
    $('.left').prepend(progresBar);
    iceriklerJSON       = await getIceriklerJSON(product_id);
    if(iceriklerJSON!='false'){ 
        createFabricJSON(iceriklerJSON);
    }
}

async function  getIceriklerJSON(product_id){ 
    return new Promise(function(resolve,reject){
        var data = new FormData();
        data.append('product_id', product_id);
        $('.fa-spin').css('margin-left','auto')
        $('.fa-spin').css('margin-right','auto')
        jQuery.ajax({
            url: '?route=tasarim/icerikver/getIceriklerArr',
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(data){
                // eğer onbellekten geldiyse baında ve sonunda ikitane çift
                // tırkan vardır onların temizlenip tek e indirilmesi gerekli
                var res = data.substring(0,1);
                if(res=='"'){
                    data = data.substring(1,data.length-1);
                }
                iceriklerArr = JSON.parse(data);
                $('.fa-spin').remove();
                resolve(iceriklerArr)
            },
            error: errorHandler = function(xhr, status, error) {
                alert("Dönüştürürken içerik bulunamadı ", error)
                reject('false');
            }
        });
    })
}


//------------------------ Create Fabric Canvas --------------------------
async function  createFabricJSON(iceriklerJSON){
    
    // zemin resmini alıp canvası oluşturalım
    let zemin           = '';
    let txtBoxArr       = [];
    let cropBoxArr      = [];
    let fligranArr      = [];
    let logoArr      = [];
    $.each(iceriklerJSON,(i,icerik)=>{
        if(icerik.tur == 'zemin'){
            zemin   = icerik; 
        }else if(icerik.tur == 'txt_kutu'){
           txtBoxArr.push(icerik)
        }else if(icerik.tur == 'resim_yer_tutucu'){
            cropBoxArr.push(icerik)
        }else if(icerik.tur == 'filigran'){
            fligranArr.push(icerik)
        }else if(icerik.tur == 'kategori_logo'){
            logoArr.push(icerik)
        }
    }) 
    // eğer ZEMIN  bulunduysa  
    $('.ag-alanseti').show();
    $('.left .col-sm-6').hide();

    async function zeminiekle(){
        return  new Promise(function(resolve,reject){
            let imgElm      = new Image();
            imgElm.src      = zemin.src;
            imgElm.onload   = function(){
                fabricObj.height        = imgElm.naturalHeight
                fabricObj.width         = imgElm.naturalWidth 
                bgImgObj.height        = imgElm.naturalHeight
                bgImgObj.width         = imgElm.naturalWidth 
                bgImgObj.agSablonResmi    = true 
                bgImgObj.evented     = false
                bgImgObj.hasControls = false
                bgImgObj.id          = "bg"
                bgImgObj.src         = imgElm.src
                fabricObj.objects.push(bgImgObj); 
                resolve(true);
            }
        })
    }
    if(zemin!=''){
        await zeminiekle();
    }
    
    
    // textBoxlar
    $.each(txtBoxArr,function(i,txtBox){
        const cloneTextBox = Object.assign({}, txtObj);
        cloneTextBox.left             = txtBox.left
        cloneTextBox.top              = txtBox.top
        cloneTextBox.width            = txtBox.width
        cloneTextBox.height           = txtBox.height 
        cloneTextBox.fill             = txtBox.color
        cloneTextBox.stroke           = txtBox.stroke_color 
        cloneTextBox.angle            = txtBox.rotation
        cloneTextBox.strokeWidth      = parseFloat(txtBox.stroke_size)
        cloneTextBox.text             = ''
        cloneTextBox.fontWeight       = txtBox.font_weight
        cloneTextBox.fontFamily       = txtBox.font_family
        cloneTextBox.fontSize         = txtBox.font_size
        cloneTextBox.fontStyle        = txtBox.font_style
        cloneTextBox.lineHeight       = txtBox.font_size
        cloneTextBox.textAlign        = txtBox.text_align 
        cloneTextBox.agKarakterLimiti = txtBox.karakter_limiti
        cloneTextBox.agKutuyaSigdir   = true
        cloneTextBox.agMaxLines       = 1
        cloneTextBox.agMaxWidth       = txtBox.width
        cloneTextBox.agFontSize       = 0
        cloneTextBox.agBosBirak       = false
        cloneTextBox.evented          = false
        cloneTextBox.hasControls      = false
        cloneTextBox.id               = 'txt_kutu'+i
        fabricObj.objects.push(cloneTextBox);
    })

    // cropBoxlar
    $.each(cropBoxArr,function(i,crpBox){
        const cloneCropBox            = Object.assign({}, cropObj);
        cloneCropBox.left             = crpBox.left
        cloneCropBox.top              = crpBox.top
        cloneCropBox.width            = crpBox.width
        cloneCropBox.height           = crpBox.height  
        cloneCropBox.angle            = crpBox.rotation  
        cloneCropBox.agBosBirak       = false
        cloneCropBox.evented          = true
        cloneCropBox.hasControls      = false
        cloneCropBox.id               = 'resim_yer_tutucu'+i
        if(!crpBox.zeminin_ustunde){
            fabricObj.objects.unshift(cloneCropBox);
        }else{
            fabricObj.objects.push(cloneCropBox);
        }
    })

    // fligranlar
    $.each(fligranArr,function(i,fligBox){
        const cloneFligranBox            = Object.assign({}, fligranObj);
        cloneFligranBox.left             = fligBox.left
        cloneFligranBox.top              = fligBox.top
        cloneFligranBox.width            = fligBox.width
        cloneFligranBox.height           = fligBox.height  
        cloneFligranBox.angle            = fligBox.rotation  
        cloneFligranBox.src              = fligBox.url  
        cloneFligranBox.agBosBirak       = false
        cloneFligranBox.evented          = false
        cloneFligranBox.hasControls      = false
        cloneFligranBox.id               = 'fligran'+i
        cloneFligranBox.agIsLogo             = true
        fabricObj.objects.push(cloneFligranBox);
    })

    // logolar
    function logoEkle(){
        return  new Promise(function(resolve,reject){
            let logoBox     = logoArr[0];
            let imgElm      = new Image();
            imgElm.src      = logoBox.url;
            imgElm.onload   = function(){
                const clonLogoBox            = Object.assign({}, logoObj);
                clonLogoBox.left             = logoBox.left
                clonLogoBox.top              = logoBox.top
                clonLogoBox.scaleX           = logoBox.height/imgElm.naturalHeight
                clonLogoBox.scaleY           = logoBox.width/imgElm.naturalWidth
                clonLogoBox.angle            = logoBox.rotation  
                clonLogoBox.src              = logoBox.url  
                clonLogoBox.agBosBirak       = false
                clonLogoBox.evented          = false
                clonLogoBox.hasControls      = false 
                clonLogoBox.id               = 'logo'+0
                clonLogoBox.agIsLogo         = true
                fabricObj.objects.push(clonLogoBox);
                resolve();
            }
            imgElm.onerror = function(){
                resolve();
            }
        })
    }
    if(logoArr.length){
        await logoEkle();
    }
    agEditor._fromJSON([JSON.stringify(fabricObj)]);

    let totalHeight =0
    $('.canvas-container').each(function (elm) {
        const cnv = $(this).find('canvas')[0] 
        $(this).css('height',cnv.scrollHeight+10+'px')
        totalHeight     +=  cnv.scrollHeight+10;
    })
    $('#ageditor').css('height',totalHeight+'px');

    console.log("Şablon dönüştürüldü")
}