var fabricObj   = {
                version:"3.6.1",
                agVersion:"1",
                objects:[],
                background:"#ffffff",
                agSmallImageUrl:"",
                height:"600",
                width:"800",
                id:1
    };

var bgImgObj    = 
    {
      "type": "image",
      "version": "3.6.1",
      "originX": "left",
      "originY": "top",
      "left": 0,
      "top": 0,
      "width": 600,
      "height": 840,
      "fill": "rgb(0,0,0)",
      "stroke": null,
      "strokeWidth": 0,
      "strokeDashArray": null,
      "strokeLineCap": "butt",
      "strokeDashOffset": 0,
      "strokeLineJoin": "miter",
      "strokeMiterLimit": 4,
      "scaleX": 1,
      "scaleY": 1,
      "angle": 0,
      "flipX": false,
      "flipY": false,
      "opacity": 1,
      "shadow": null,
      "visible": true,
      "clipTo": null,
      "backgroundColor": "",
      "fillRule": "nonzero",
      "paintFirst": "fill",
      "globalCompositeOperation": "source-over",
      "transformMatrix": null,
      "skewX": 0,
      "skewY": 0,
      "crossOrigin": "",
      "cropX": 0,
      "cropY": 0,
      "agSablonResmi": true,
      "evented": false,
      "hasControls": false,
      "id": "bg",
      "src": "",
      "filters": []
    }

var txtObj      = {
    "type": "textbox",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 213,
    "top": 112,
    "width": 200,
    "height": 27.119999999999994,
    "fill": "#000000",
    "stroke": "#ffffff",
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "round",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "text": "sssssss",
    "fontSize": 24,
    "fontWeight": "normal",
    "fontFamily": "arial",
    "fontStyle": "normal",
    "lineHeight": 1.16,
    "underline": false,
    "overline": false,
    "linethrough": false,
    "textAlign": "center",
    "textBackgroundColor": "",
    "charSpacing": 0,
    "minWidth": 20,
    "splitByGrapheme": false,
    "agKarakterLimiti": 30,
    "agKutuyaSigdir": 1,
    "agMaxLines": 1,
    "agMaxWidth": 200,
    "agFontSize": 24,
    "agBosBirak": false,
    "evented": true,
    "hasControls": false,
    "id": 91249,
    "styles": {}
    }

var cropObj     = {
    "type": "image",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 154,
    "top": 231,
    "width": 192,
    "height": 192,
    "fill": "rgb(0,0,0)",
    "stroke": null,
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "miter",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "crossOrigin": "",
    "cropX": 0,
    "cropY": 0,
    "agBosBirak": false,
    "agImageUrl":"",
    "evented": true,
    "hasControls": true,
    "id": "",
    "src": agBaseURL+"/editor/agblank.png",
    "filters": []
    }

var fligranObj  = {
    "type": "image",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 154,
    "top": 231,
    "width": 192,
    "height": 192,
    "fill": "rgb(0,0,0)",
    "stroke": null,
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "miter",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "crossOrigin": "",
    "cropX": 0,
    "cropY": 0,
    "agBosBirak": false,
    "agIsLogo":true,
    "evented": false,
    "hasControls": true,
    "id": 50752,
    "src": agBaseURL+"/editor/agblank.png",
    "filters": []
    }

var logoObj  = {
    "type": "image",
    "version": "3.6.1",
    "originX": "left",
    "originY": "top",
    "left": 154,
    "top": 231,
    "width": 192,
    "height": 192,
    "fill": "rgb(0,0,0)",
    "stroke": null,
    "strokeWidth": 0,
    "strokeDashArray": null,
    "strokeLineCap": "butt",
    "strokeDashOffset": 0,
    "strokeLineJoin": "miter",
    "strokeMiterLimit": 4,
    "scaleX": 1,
    "scaleY": 1,
    "angle": 0,
    "flipX": false,
    "flipY": false,
    "opacity": 1,
    "shadow": null,
    "visible": true,
    "clipTo": null,
    "backgroundColor": "",
    "fillRule": "nonzero",
    "paintFirst": "fill",
    "globalCompositeOperation": "source-over",
    "transformMatrix": null,
    "skewX": 0,
    "skewY": 0,
    "crossOrigin": "",
    "cropX": 0,
    "cropY": 0,
    "agBosBirak": false,
    "agIsLogo":true,
    "evented": false,
    "hasControls": true,
    "id": 50752,
    "src": agBaseURL+"/editor/agblank.png",
    "filters": []
}

var progresBar = '<i class="fa fa-cog fa-spin" style="' + 
                'margin-left: auto;'+
                'margin-right: auto;'+
                'display: block;'+
                'width: 257px;'+
                'height: 300px;'+
                'font-size:300px;color:green"'+'></i>'

var buyukZeminResmiURL = '';

var temaKodlari=[];
    temaKodlari['0001'] = '0001'
    temaKodlari['0003'] = '0001'
    temaKodlari['0062'] = '0001'
    temaKodlari['0122'] = '0001'
    temaKodlari['0108'] = '0001'
    temaKodlari['0110'] = '0001'
    temaKodlari['0003'] = '0001'
    temaKodlari['0052'] = '0001'
    temaKodlari['0002'] = '0002'
    temaKodlari['0004'] = '0002'
    temaKodlari['0063'] = '0002'
    temaKodlari['0123'] = '0002'
    temaKodlari['0109'] = '0002'
    temaKodlari['0111'] = '0002'
    temaKodlari['0053'] = '0002'
    temaKodlari['0005'] = '0005'
    temaKodlari['0007'] = '0005'
    temaKodlari['0013'] = '0005'
    temaKodlari['0015'] = '0005'
    temaKodlari['0037'] = '0005'
    temaKodlari['0044'] = '0005'
    temaKodlari['0046'] = '0005'
    temaKodlari['0048'] = '0005'
    temaKodlari['0056'] = '0005'
    temaKodlari['0058'] = '0005'
    temaKodlari['0060'] = '0005'
    temaKodlari['0097'] = '0005'
    temaKodlari['0104'] = '0005'
    temaKodlari['0128'] = '0005'
    temaKodlari['0006'] = '0006'
    temaKodlari['0008'] = '0006'
    temaKodlari['0014'] = '0006'
    temaKodlari['0016'] = '0006'
    temaKodlari['0037R'] = '0006'
    temaKodlari['0045'] = '0006'
    temaKodlari['0047'] = '0006'
    temaKodlari['0049'] = '0006'
    temaKodlari['0057'] = '0006'
    temaKodlari['0059'] = '0006'
    temaKodlari['0061'] = '0006'
    temaKodlari['0098'] = '0006'
    temaKodlari['0105'] = '0006'
    temaKodlari['0129'] = '0006'
    temaKodlari['0031A'] = '0031'
    temaKodlari['0031KA'] = '0031'
    temaKodlari['0031'] = '0031'
    temaKodlari['0050'] = '0031'
    temaKodlari['0074'] = '0031'
    temaKodlari['0083'] = '0031'
    temaKodlari['0087'] = '0031'
    temaKodlari['0093'] = '0031'
    temaKodlari['0095'] = '0031'
    temaKodlari['0099'] = '0031'
    temaKodlari['0032KA'] = '0032'
    temaKodlari['0032A'] = '0032'
    temaKodlari['0032'] = '0032'
    temaKodlari['0075'] = '0032'
    temaKodlari['0084'] = '0032'
    temaKodlari['0088'] = '0032'
    temaKodlari['0094'] = '0032'
    temaKodlari['0096'] = '0032'
    temaKodlari['0100'] = '0032'
    temaKodlari['0031'] = '0031'
    temaKodlari['0050'] = '0031'
    temaKodlari['0074'] = '0031'
    temaKodlari['0083'] = '0031'
    temaKodlari['0087'] = '0031'
    temaKodlari['0093'] = '0031'
    temaKodlari['0095'] = '0031'
    temaKodlari['0099'] = '0031'
    temaKodlari['0032'] = '0032'
    temaKodlari['0051'] = '0032'
    temaKodlari['0075'] = '0032'
    temaKodlari['0084'] = '0032'
    temaKodlari['0088'] = '0032'
    temaKodlari['0094'] = '0032'
    temaKodlari['0096'] = '0032'
    temaKodlari['0100'] = '0032'
    temaKodlari['0038'] = '0038'
    temaKodlari['0040'] = '0038'
    temaKodlari['0039'] = '0039'
    temaKodlari['0041'] = '0039'
    temaKodlari['0055'] = '0055'
    temaKodlari['0072'] = '0072'
    temaKodlari['0073'] = '0073'
    temaKodlari['0082'] = '0082'
    temaKodlari['0102'] = '0102'
    temaKodlari['0106'] = '0102'
    temaKodlari['0103'] = '0103'
    temaKodlari['0107'] = '0103'
    temaKodlari['0130'] = '0130'
    temaKodlari['0131'] = '0131'
    temaKodlari['0089'] = '0089'
    temaKodlari['0090'] = '0090'
    temaKodlari['0091'] = '0089'
    temaKodlari['0092'] = '0090'
    temaKodlari['0124'] = '0089'
    temaKodlari['0125'] = '0090'
    temaKodlari['0017'] = '0011'
    temaKodlari['0018'] = '0012'
    temaKodlari['0011'] = '0011'
    temaKodlari['0012'] = '0012'
    temaKodlari['0085'] = '0011'
    temaKodlari['0086'] = '0012'
    temaKodlari['0021'] = '0011'
    temaKodlari['0022'] = '0012'
    temaKodlari['0019'] = '0011'
    temaKodlari['0020'] = '0012'
    temaKodlari['0064'] = '0089'
    temaKodlari['0065'] = '0090'
    temaKodlari['0023'] = '0089'
    temaKodlari['0024'] = '0090'
    temaKodlari['00231'] = '00231'
    temaKodlari['00232'] = '00232'
    temaKodlari['0138'] = '0102'
    temaKodlari['0139'] = '0103'
    temaKodlari['9998'] = '9998'
    temaKodlari['9999'] = '9999'
    temaKodlari['0140'] = '0005'
    temaKodlari['0141'] = '0006'
    temaKodlari['0081'] = '0081'
    temaKodlari['0082'] = '0081'
    temaKodlari['mnion0003'] = 'mnion0003'
    temaKodlari['mnion0004'] = 'mnion0003'
    temaKodlari['MG0029'] = 'mnion0003'
    temaKodlari['mnion0111'] = 'mnion0003'
    temaKodlari['0154'] = '0031'
    temaKodlari['0155'] = '0032'
    temaKodlari['0156'] = '0031'
    temaKodlari['0157'] = '0032'
    temaKodlari['0158'] = '0031'
    temaKodlari['0159'] = '0032'
    temaKodlari['0160'] = '0130'
    temaKodlari['0161'] = '0131'
    temaKodlari['0132'] = '0132'
    temaKodlari['0133'] = '0133'
    temaKodlari['0134'] = '0134'
    temaKodlari['0135'] = '0135'
    temaKodlari['0136'] = '0136'
    temaKodlari['0137'] = '0137'
    temaKodlari['0158'] = '0134'
    temaKodlari['0159'] = '0135'
    temaKodlari['0152'] = '0132'
    temaKodlari['0153'] = '0133'
    temaKodlari['0150'] = '0150'
    temaKodlari['0151'] = '0151'
    temaKodlari['T713'] = 'T713'
    temaKodlari['T708'] = 'T708'
    temaKodlari['T707'] = 'T707'
    temaKodlari['T709'] = 'T709'
    temaKodlari['T704'] = 'T704'
    temaKodlari['T700'] = 'T700'

var koseNoktalari=[];
    koseNoktalari['T700'] = ['2','6']
    koseNoktalari['T704'] = ['26','8']
    koseNoktalari['T707'] = ['10','2']
    koseNoktalari['T708'] = ['10','2']
    koseNoktalari['T713'] = ['10','2']
    koseNoktalari['0001'] = ['17','98']
    koseNoktalari['0002'] = ['17','98']
    koseNoktalari['0003'] = ['17','98']
    koseNoktalari['0004'] = ['17','98']
    koseNoktalari['0005'] = ['64','64']
    koseNoktalari['0006'] = ['64','64']
    koseNoktalari['0007'] = ['64','64']
    koseNoktalari['0008'] = ['64','64']
    koseNoktalari['0009'] = ['64','64']
    koseNoktalari['0010'] = ['64','64']
    koseNoktalari['0011'] = ['220','10']
    koseNoktalari['0012'] = ['220','10']
    koseNoktalari['0013'] = ['64','64']
    koseNoktalari['0014'] = ['64','64']
    koseNoktalari['0015'] = ['64','64']
    koseNoktalari['0016'] = ['64','64']
    koseNoktalari['0017'] = ['220','10']
    koseNoktalari['0018'] = ['220','10']
    koseNoktalari['0019'] = ['220','10']
    koseNoktalari['0020'] = ['220','10']
    koseNoktalari['0021'] = ['220','10']
    koseNoktalari['0022'] = ['220','10']
    koseNoktalari['0023'] = ['98','17']
    koseNoktalari['0024'] = ['98','17']
    koseNoktalari['0025'] = ['17','222']
    koseNoktalari['0026'] = ['17','222']
    koseNoktalari['0027'] = ['64','64']
    koseNoktalari['0028'] = ['64','64']
    koseNoktalari['0029'] = ['220','10']
    koseNoktalari['0030'] = ['220','10']
    koseNoktalari['0031'] = ['64','64']
    koseNoktalari['0032'] = ['64','64']
    koseNoktalari['0033'] = ['64','64']
    koseNoktalari['0034'] = ['64','64']
    koseNoktalari['0035'] = ['64','64']
    koseNoktalari['0036'] = ['64','64']
    koseNoktalari['0037'] = ['64','64']
    koseNoktalari['0037R'] = ['64','64']
    koseNoktalari['0038'] = ['100','17']
    koseNoktalari['0039'] = ['100','17']
    koseNoktalari['0040'] = ['100','17']
    koseNoktalari['0041'] = ['100','17']
    koseNoktalari['0042'] = ['64','64']
    koseNoktalari['0043'] = ['64','64']
    koseNoktalari['0044'] = ['64','64']
    koseNoktalari['0045'] = ['64','64']
    koseNoktalari['0046'] = ['64','64']
    koseNoktalari['0047'] = ['64','64']
    koseNoktalari['0048'] = ['64','64']
    koseNoktalari['0049'] = ['64','64']
    koseNoktalari['0050'] = ['64','64']
    koseNoktalari['0051'] = ['64','64']
    koseNoktalari['0052'] = ['64','64']
    koseNoktalari['0053'] = ['64','64']
    koseNoktalari['0054'] = ['64','64']
    koseNoktalari['0055'] = ['116','17']
    koseNoktalari['0055R'] = ['116','17']
    koseNoktalari['0056'] = ['64','64']
    koseNoktalari['0057'] = ['64','64']
    koseNoktalari['0058'] = ['64','64']
    koseNoktalari['0059'] = ['64','64']
    koseNoktalari['0060'] = ['64','64']
    koseNoktalari['0061'] = ['64','64']
    koseNoktalari['0062'] = ['17','98']
    koseNoktalari['0063'] = ['17','98']
    koseNoktalari['0064'] = ['64','64']
    koseNoktalari['0065'] = ['64','64']
    koseNoktalari['0066'] = ['64','64']
    koseNoktalari['0067'] = ['64','64']
    koseNoktalari['0068'] = ['64','64']
    koseNoktalari['0069'] = ['64','64']
    koseNoktalari['0070'] = ['64','64']
    koseNoktalari['0071'] = ['64','64']
    koseNoktalari['0072'] = ['194','17']
    koseNoktalari['0073'] = ['194','17']
    koseNoktalari['0074'] = ['64','64']
    koseNoktalari['0075'] = ['64','64']
    koseNoktalari['0076'] = ['64','64']
    koseNoktalari['0077'] = ['64','64']
    koseNoktalari['0078'] = ['64','64']
    koseNoktalari['0079'] = ['64','64']
    koseNoktalari['0080'] = ['64','64']
    koseNoktalari['0081'] = ['64','64']
    koseNoktalari['0082'] = ['102','17']
    koseNoktalari['0083'] = ['64','64']
    koseNoktalari['0084'] = ['64','64']
    koseNoktalari['0085'] = ['220','10']
    koseNoktalari['0086'] = ['220','10']
    koseNoktalari['0087'] = ['64','64']
    koseNoktalari['0088'] = ['64','64']
    koseNoktalari['0089'] = ['98','17']
    koseNoktalari['0090'] = ['98','17']
    koseNoktalari['0091'] = ['98','17']
    koseNoktalari['0092'] = ['98','17']
    koseNoktalari['0093'] = ['64','64']
    koseNoktalari['0094'] = ['64','64']
    koseNoktalari['0095'] = ['64','64']
    koseNoktalari['0096'] = ['64','64']
    koseNoktalari['0097'] = ['64','64']
    koseNoktalari['0098'] = ['64','64']
    koseNoktalari['0099'] = ['64','64']
    koseNoktalari['0100'] = ['64','64']
    koseNoktalari['0101'] = ['64','64']
    koseNoktalari['0102'] = ['17','98']
    koseNoktalari['0103'] = ['17','98']
    koseNoktalari['0104'] = ['64','64']
    koseNoktalari['0105'] = ['64','64']
    koseNoktalari['0106'] = ['17','98']
    koseNoktalari['0107'] = ['17','98']
    koseNoktalari['0108'] = ['17','98']
    koseNoktalari['0109'] = ['17','98']
    koseNoktalari['0110'] = ['17','98']
    koseNoktalari['0111'] = ['17','98']
    koseNoktalari['0112'] = ['64','64']
    koseNoktalari['0113'] = ['64','64']
    koseNoktalari['0114'] = ['64','64']
    koseNoktalari['0115'] = ['64','64']
    koseNoktalari['0116'] = ['64','64']
    koseNoktalari['0117'] = ['64','64']
    koseNoktalari['0118'] = ['64','64']
    koseNoktalari['0119'] = ['64','64']
    koseNoktalari['0120'] = ['64','64']
    koseNoktalari['0121'] = ['64','64']
    koseNoktalari['0122'] = ['17','98']
    koseNoktalari['0123'] = ['17','98']
    koseNoktalari['0124'] = ['98','17']
    koseNoktalari['0125'] = ['98','17']
    koseNoktalari['0126'] = ['64','64']
    koseNoktalari['0127'] = ['64','64']
    koseNoktalari['0128'] = ['64','64']
    koseNoktalari['0129'] = ['64','64']
    koseNoktalari['0130'] = ['17','164']
    koseNoktalari['0131'] = ['17','164']
    koseNoktalari['0132'] = ['64','64']
    koseNoktalari['0133'] = ['64','64']
    koseNoktalari['0134'] = ['64','64']
    koseNoktalari['0135'] = ['64','64']
    koseNoktalari['0136'] = ['64','64']
    koseNoktalari['0137'] = ['64','64']
    koseNoktalari['0138'] = ['64','64']
    koseNoktalari['0139'] = ['64','64']
    koseNoktalari['0140'] = ['64','64']
    koseNoktalari['0141'] = ['64','64']
    koseNoktalari['0142'] = ['64','64']
    koseNoktalari['0143'] = ['64','64']

async function eskiVersiondanDonustur(){        
    iceriklerJSON       = await getIceriklerJSON(product_id);
    if(iceriklerJSON!='false'){ 
        buyukZeminResmiURL = parseProductModelNo();
        createFabricJSON(iceriklerJSON);    
    }
}

function parseProductModelNo(){
    if(!$('#agModelNo').length){ 
         console.log("Model No Bulunamadı !")
         return;
    } 
    dir             = "/agorjinalresimler/"
    model           = $('#agModelNo').val();
    model_suffixarr = model.match(/\d/g);
    model_suffix    = model_suffixarr.join("");
    ilk_rakam_pos   = model.indexOf(model_suffixarr[0])
    model_prefix    = model.substring(0 , ilk_rakam_pos);
    if(temaKodlari[model_suffix]){
        resimAdi        = model_prefix + temaKodlari[model_suffix] + '.png'
    }else{
        resimAdi        = model + '.png'
    }

    let url             = dir+resimAdi;
    /*new Promise(resolve => {
        let orjinalResim = new Image(); 
        orjinalResim.onload     = function (img) {
            buyukResimW         = this.width
            buyukResimH         = this.height 
            console.log("Resim yüklenemedi  : " + url); 
            resolve(true);
        };
        orjinalResim.onerror = function() {
            console.log("Büyük zemin yüklendi  : " + url); 
            resolve(false);
        };
        orjinalResim.src = url;
    });*/
    return url;
}

async function  getIceriklerJSON(product_id){ 
    return new Promise(function(resolve,reject){
        var data = new FormData();
        data.append('product_id', product_id);
        //$('.fa-spin').css('margin-left','auto')
        //$('.fa-spin').css('margin-right','auto')
        jQuery.ajax({
            url: '/?route=tasarim/icerikver/getIceriklerArr',
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function(data){
                // eğer onbellekten geldiyse baında ve sonunda ikitane çift
                // tırkan vardır onların temizlenip tek e indirilmesi gerekli
                var res = data.substring(0,1);
                if(res=='"'){
                    data = data.substring(1,data.length-1);
                }
                iceriklerArr = JSON.parse(data);
                $('.fa-spin').remove();
                console.log("Eski versiyondan dönüşüm yapıldı product_id:"+product_id)
                resolve(iceriklerArr)
            },
            error: errorHandler = function(xhr, status, error) {
                alert("Dönüştürürken içerik bulunamadı ", error)
                reject('false');
            }
        });
    })
}

//------------------------ Create Fabric Canvas --------------------------
async function  createFabricJSON(iceriklerJSON){
    
    // zemin resmini alıp canvası oluşturalım
    let zemin           = '';
    let txtBoxArr       = [];
    let cropBoxArr      = [];
    let fligranArr      = [];
    let logoArr      = [];
    $.each(iceriklerJSON,(i,icerik)=>{
        if(icerik.tur == 'zemin'){
            zemin   = icerik; 
        }else if(icerik.tur == 'txt_kutu'){
           txtBoxArr.push(icerik)
        }else if(icerik.tur == 'resim_yer_tutucu'){
            cropBoxArr.push(icerik)
        }else if(icerik.tur == 'filigran'){
            fligranArr.push(icerik)
        }else if(icerik.tur == 'kategori_logo'){
            logoArr.push(icerik)
        }
    }) 
    // eğer ZEMIN  bulunduysa  
    $('.ag-alanseti').show();
    $('.left .col-sm-6').hide();

    async function zeminiekle(){
        return  new Promise(function(resolve,reject){
            let imgElm      = new Image();
            imgElm.src      = zemin.src;
            imgElm.onload   = function(){
                fabricObj.height        = imgElm.naturalHeight
                fabricObj.width         = imgElm.naturalWidth 
                fabricObj.agBigImgSrc   = buyukZeminResmiURL 
                bgImgObj.height         = imgElm.naturalHeight
                bgImgObj.width          = imgElm.naturalWidth 
                bgImgObj.agSablonResmi  = true 
                bgImgObj.evented        = false
                bgImgObj.hasControls    = false
                bgImgObj.id             = "bg"
                bgImgObj.src            = imgElm.src 
                fabricObj.objects.push(bgImgObj); 
                resolve(true);
            }
        })
    }
    if(zemin!=''){
        await zeminiekle();
    }
    
    
    // textBoxlar
    $.each(txtBoxArr,function(i,txtBox){
        const cloneTextBox = Object.assign({}, txtObj);
        cloneTextBox.left             = txtBox.left
        cloneTextBox.top              = txtBox.top
        cloneTextBox.width            = txtBox.width
        cloneTextBox.height           = txtBox.height 
        cloneTextBox.fill             = txtBox.color
        cloneTextBox.stroke           = txtBox.stroke_color 
        cloneTextBox.angle            = txtBox.rotation
        cloneTextBox.strokeWidth      = parseFloat(txtBox.stroke_size)
        cloneTextBox.text             = ''
        cloneTextBox.fontWeight       = txtBox.font_weight
        cloneTextBox.fontFamily       = txtBox.font_family
        cloneTextBox.fontSize         = txtBox.font_size
        cloneTextBox.fontStyle        = txtBox.font_style
        cloneTextBox.lineHeight       = txtBox.font_size
        cloneTextBox.textAlign        = txtBox.text_align 
        cloneTextBox.agKarakterLimiti = txtBox.karakter_limiti
        cloneTextBox.agKutuyaSigdir   = true
        cloneTextBox.agMaxLines       = 1
        cloneTextBox.agMaxWidth       = txtBox.width
        cloneTextBox.agFontSize       = 0
        cloneTextBox.agBosBirak       = false
        cloneTextBox.evented          = true
        cloneTextBox.hasControls      = false
        cloneTextBox.id               = 'txt_kutu'+i
        fabricObj.objects.push(cloneTextBox);
    })

    // cropBoxlar
    $.each(cropBoxArr,function(i,crpBox){
        const cloneCropBox            = Object.assign({}, cropObj);
        cloneCropBox.left             = crpBox.left
        cloneCropBox.top              = crpBox.top
        cloneCropBox.width            = crpBox.width
        cloneCropBox.height           = crpBox.height  
        cloneCropBox.angle            = crpBox.rotation  
        cloneCropBox.agBosBirak       = false
        cloneCropBox.evented          = true
        cloneCropBox.hasControls      = false
        cloneCropBox.id               = 'resim_yer_tutucu'+i
        if(!crpBox.zeminin_ustunde){
            fabricObj.objects.unshift(cloneCropBox);
        }else{
            fabricObj.objects.push(cloneCropBox);
        }
    })

    // fligranlar
    $.each(fligranArr,function(i,fligBox){
        const cloneFligranBox            = Object.assign({}, fligranObj);
        cloneFligranBox.left             = fligBox.left
        cloneFligranBox.top              = fligBox.top
        cloneFligranBox.width            = fligBox.width
        cloneFligranBox.height           = fligBox.height  
        cloneFligranBox.angle            = fligBox.rotation  
        cloneFligranBox.src              = fligBox.url  
        cloneFligranBox.agBosBirak       = false
        cloneFligranBox.evented          = false
        cloneFligranBox.hasControls      = false
        cloneFligranBox.id               = 'fligran'+i
        cloneFligranBox.agIsLogo         = true
        fabricObj.objects.push(cloneFligranBox);
    })

    // logolar
    function logoEkle(){
        return  new Promise(function(resolve,reject){
            let logoBox     = logoArr[0];
            let imgElm      = new Image();
            imgElm.src      = logoBox.url;
            imgElm.onload   = function(){
                const clonLogoBox            = Object.assign({}, logoObj);
                clonLogoBox.left             = logoBox.left
                clonLogoBox.top              = logoBox.top
                clonLogoBox.scaleX           = logoBox.height/imgElm.naturalHeight
                clonLogoBox.scaleY           = logoBox.width/imgElm.naturalWidth
                clonLogoBox.angle            = logoBox.rotation  
                clonLogoBox.src              = logoBox.url  
                clonLogoBox.agBosBirak       = false
                clonLogoBox.evented          = false
                clonLogoBox.hasControls      = false 
                clonLogoBox.id               = 'logo'+0
                //clonLogoBox.agIsLogo         = true
                fabricObj.objects.push(clonLogoBox);
                resolve();
            }
            imgElm.onerror = function(){
                resolve();
            }
        })
    }
    if(logoArr.length){
        await logoEkle();
    }
    agEditor._fromJSON([JSON.stringify(fabricObj)]);

    let totalHeight =0
    $('.canvas-container').each(function (elm) {
        const cnv = $(this).find('canvas')[0] 
        $(this).css('height',cnv.scrollHeight+10+'px')
        totalHeight     +=  cnv.scrollHeight+10;
    })
    $('#ageditor').css('height',totalHeight+'px');

    console.log("Şablon dönüştürüldü")
}